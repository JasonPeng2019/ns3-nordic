# -*- Mode: python; py-indent-offset: 4; indent-tabs-mode: nil; coding: utf-8; -*-

# NS-3 BLE Mesh Discovery Protocol Module
# Based on the protocol specification by jason.peng (November 2025)
#
# This module implements a scalable BLE mesh discovery protocol with:
# - Discovery messages with TTL, PSF (Path So Far), and GPS location
# - 3-metric message forwarding (Picky Forwarding, GPS Proximity, TTL)
# - RSSI-based clusterhead election
# - Cluster capacity limiting (150 devices per cluster)
# - Multi-path routing with Dijkstra's shortest path

def build(bld):
    module = bld.create_ns3_module('ble-mesh-discovery', ['core', 'network',
                                                           'spectrum', 'mobility',
                                                           'energy', 'propagation',
                                                           'ble', 'csma',
                                                           'applications', 'internet',
                                                           'internet-apps'])
    module.includes = [
        '.',
        'model',
        'model/protocol-core',
        'model/engine-core',
    ]
    module.source = [
        # Pure C protocol core (portable to embedded systems)
        'model/protocol-core/ble_discovery_packet.c',
        'model/protocol-core/ble_mesh_node.c',
        'model/protocol-core/ble_discovery_cycle.c',
        'model/protocol-core/ble_message_queue.c',
        'model/protocol-core/ble_forwarding_logic.c',
        'model/protocol-core/ble_election.c',
        'model/protocol-core/ble_broadcast_timing.c',
        'model/engine-core/ble_discovery_engine.c',

        # C++ wrapper for NS-3 integration
        'model/ble-discovery-header-wrapper.cc',
        'model/ble-election-header.cc',
        'model/ble-mesh-node-wrapper.cc',
        'model/ble-discovery-cycle-wrapper.cc',
        'model/ble-message-queue.cc',
        'model/ble-forwarding-logic.cc',
        'model/ble-broadcast-timing.cc',
        'model/ble-discovery-engine-wrapper.cc',

        # Future model files
        # 'model/ble-discovery-protocol.cc',
        # 'model/ble-cluster-election.cc',
        # 'model/ble-cluster-manager.cc',
        # 'model/ble-mesh-routing.cc',

        # Helper files will go here
        # 'helper/ble-mesh-helper.cc',
        # 'helper/ble-cluster-helper.cc',
        ]

    module_test = bld.create_ns3_module_test_library('ble-mesh-discovery')
    module_test.source = [
        # Test files
        'test/ble-discovery-header-test.cc',
        'test/ble-mesh-node-test.cc',
        'test/ble-discovery-cycle-test.cc',
        'test/ble-message-queue-test.cc',
        'test/ble-forwarding-logic-test.cc',
        'test/ble-broadcast-timing-test.cc',
        ]

    headers = bld(features='ns3header')
    headers.module = 'ble-mesh-discovery'
    headers.source = [
        # Pure C protocol headers (can be used standalone)
        'model/protocol-core/ble_discovery_packet.h',
        'model/protocol-core/ble_election.h',
        'model/protocol-core/ble_mesh_node.h',
        'model/protocol-core/ble_discovery_cycle.h',
        'model/protocol-core/ble_message_queue.h',
        'model/protocol-core/ble_forwarding_logic.h',
        'model/protocol-core/ble_broadcast_timing.h',
        'model/engine-core/ble_discovery_engine.h',

        # C++ wrapper header
        'model/ble-discovery-header-wrapper.h',
        'model/ble-election-header.h',
        'model/ble-mesh-node-wrapper.h',
        'model/ble-discovery-cycle-wrapper.h',
        'model/ble-message-queue.h',
        'model/ble-forwarding-logic.h',
        'model/ble-broadcast-timing.h',
        'model/ble-discovery-engine-wrapper.h',

        # Future model headers
        # 'model/ble-discovery-protocol.h',
        # 'model/ble-cluster-election.h',
        # 'model/ble-cluster-manager.h',
        # 'model/ble-mesh-routing.h',

        # Helper headers will go here
        # 'helper/ble-mesh-helper.h',
        # 'helper/ble-cluster-helper.h',
        ]

    if bld.env.ENABLE_EXAMPLES:
        bld.recurse('examples')
        bld.recurse('engine_sim')

    # Always build task tests (standalone test programs)
    bld.recurse('test/task_tests')
